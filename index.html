<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Navegação AR GPS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame + AR.js com GPS -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px 14px;
        border-radius: 10px;
        font-family: sans-serif;
      }
    </style>
  </head>

  <body>
    <div id="info">Carregando localização...</div>

    <a-scene
      xr-mode-ui="enabled: false"
      embedded
      renderer="antialias: true; alpha: true; precision: mediump;"
      arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; trackingMethod: best; cameraParametersUrl: https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/data/data/camera_para.dat;"
    >
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      // Função utilitária para calcular coordenadas 5 metros à frente
      function deslocarCoordenadas(lat, lon, distancia, direcaoGraus) {
        const R = 6378137; // raio da Terra em metros
        const dLat = (distancia * Math.cos((direcaoGraus * Math.PI) / 180)) / R;
        const dLon =
          (distancia *
            Math.sin((direcaoGraus * Math.PI) / 180)) /
          (R * Math.cos((lat * Math.PI) / 180));

        const novaLat = lat + dLat * (180 / Math.PI);
        const novaLon = lon + dLon * (180 / Math.PI);

        return { lat: novaLat, lon: novaLon };
      }

      const info = document.getElementById("info");

      // Espera até obter a localização atual
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          // desloca 5 metros à frente (norte)
          const destino = deslocarCoordenadas(lat, lon, 5, 0);

          info.textContent = `Lat: ${lat.toFixed(
            6
          )}, Lon: ${lon.toFixed(6)} | Modelo a 5m`;

          // cria o modelo dinamicamente
          const cena = document.querySelector("a-scene");
          const modelo = document.createElement("a-entity");

          modelo.setAttribute("gps-entity-place", {
            latitude: destino.lat,
            longitude: destino.lon,
          });
          modelo.setAttribute("gltf-model", "./modelos/Cubo.glb");
          modelo.setAttribute("scale", "1 1 1");
          modelo.setAttribute("rotation", "0 180 0");
          modelo.setAttribute("animation-mixer", "");
          cena.appendChild(modelo);
        },
        (err) => {
          info.textContent = "Erro ao obter localização: " + err.message;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0,
        }
      );
    </script>
  </body>
</html>
