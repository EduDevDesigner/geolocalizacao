<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Navega√ß√£o AR GPS Din√¢mica</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        background: rgba(0, 0, 0, 0.6);
        padding: 8px 14px;
        border-radius: 10px;
        font-family: sans-serif;
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <div id="info">Obtendo localiza√ß√£o...</div>

    <a-scene
      xr-mode-ui="enabled: false"
      embedded
      renderer="antialias: true; alpha: true;"
      arjs="sourceType: webcam; videoTexture: true; trackingMethod: best; debugUIEnabled: false;"
    >
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const info = document.getElementById("info");
      const cena = document.querySelector("a-scene");
      let modelo = null;
      let destino = null;

      // Fun√ß√£o para calcular coordenadas deslocadas (5 metros √† frente)
      function deslocarCoordenadas(lat, lon, distancia, direcaoGraus) {
        const R = 6378137;
        const dLat = (distancia * Math.cos((direcaoGraus * Math.PI) / 180)) / R;
        const dLon =
          (distancia * Math.sin((direcaoGraus * Math.PI) / 180)) /
          (R * Math.cos((lat * Math.PI) / 180));

        const novaLat = lat + dLat * (180 / Math.PI);
        const novaLon = lon + dLon * (180 / Math.PI);
        return { lat: novaLat, lon: novaLon };
      }

      // Fun√ß√£o para calcular dist√¢ncia entre dois pontos GPS
      function distanciaMetros(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Inicializa o modelo quando a posi√ß√£o √© obtida
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          if (!destino) {
            destino = deslocarCoordenadas(lat, lon, 5, 0); // 5 metros ao norte

            // cria o modelo
            modelo = document.createElement("a-entity");
            modelo.setAttribute("gps-entity-place", {
              latitude: destino.lat,
              longitude: destino.lon,
            });
            modelo.setAttribute("gltf-model", "./modelos/Cubo.glb");
            modelo.setAttribute("scale", "1 1 1");
            modelo.setAttribute("rotation", "0 180 0");
            modelo.setAttribute("animation", "property: rotation; to: 0 540 0; loop: true; dur: 4000");
            cena.appendChild(modelo);
          }

          const distancia = distanciaMetros(lat, lon, destino.lat, destino.lon);
          info.textContent = `üìç Lat: ${lat.toFixed(
            6
          )}, Lon: ${lon.toFixed(
            6
          )} | Dist√¢ncia: ${distancia.toFixed(2)} m`;

          // Se estiver a menos de 1 metro do destino, mover o alvo mais √† frente
          if (distancia < 1) {
            destino = deslocarCoordenadas(lat, lon, 5, 0);
            modelo.setAttribute("gps-entity-place", {
              latitude: destino.lat,
              longitude: destino.lon,
            });
            info.textContent = "üéØ Novo destino definido a 5 metros!";
          }
        },
        (err) => {
          info.textContent = "Erro ao obter localiza√ß√£o: " + err.message;
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000,
        }
      );
    </script>
  </body>
</html>
