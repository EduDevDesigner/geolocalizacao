<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>AR GPS - Modelo a 2 Metros</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame + AR.js (com suporte GPS) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      #info {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 10px 16px;
        border-radius: 8px;
        font-family: sans-serif;
        z-index: 10;
      }
    </style>
  </head>

  <body>
    <div id="info">üìç Obtendo localiza√ß√£o...</div>

    <a-scene
      embedded
      xr-mode-ui="enabled: false"
      renderer="antialias: true; alpha: true;"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    >
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const info = document.getElementById("info");
      const cena = document.querySelector("a-scene");
      let modeloCriado = false;

      // Fun√ß√£o para deslocar latitude/longitude uma dist√¢ncia (em metros)
      function deslocarCoordenadas(lat, lon, distancia, direcaoGraus) {
        const R = 6378137; // raio da Terra em metros
        const dLat = (distancia * Math.cos((direcaoGraus * Math.PI) / 180)) / R;
        const dLon =
          (distancia * Math.sin((direcaoGraus * Math.PI) / 180)) /
          (R * Math.cos((lat * Math.PI) / 180));
        return {
          lat: lat + dLat * (180 / Math.PI),
          lon: lon + dLon * (180 / Math.PI),
        };
      }

      // Dist√¢ncia em metros (f√≥rmula haversine)
      function distanciaMetros(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Assim que carregar a posi√ß√£o inicial
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy;

          info.textContent = `üìç Localiza√ß√£o inicial obtida (¬±${acc.toFixed(1)} m)`;

          // Define o modelo 2 metros √† frente (0¬∞ = norte)
          const destino = deslocarCoordenadas(lat, lon, 2, 0);

          // Cria o modelo
          const modelo = document.createElement("a-entity");
          modelo.setAttribute("id", "modelo3d");
          modelo.setAttribute("gps-entity-place", {
            latitude: destino.lat,
            longitude: destino.lon,
          });
          modelo.setAttribute("gltf-model", "./modelos/Cubo.glb"); // seu modelo local
          modelo.setAttribute("scale", "1 1 1");
          modelo.setAttribute("rotation", "0 180 0");
          modelo.setAttribute("animation", "property: rotation; to: 0 360 0; loop: true; dur: 5000");
          cena.appendChild(modelo);

          modeloCriado = true;

          // Agora monitora dist√¢ncia em tempo real
          navigator.geolocation.watchPosition(
            (pos2) => {
              const dist = distanciaMetros(
                pos2.coords.latitude,
                pos2.coords.longitude,
                destino.lat,
                destino.lon
              );
              info.textContent = `üìè Dist√¢ncia do modelo: ${dist.toFixed(2)} m`;
            },
            (err) => {
              info.textContent = "Erro ao atualizar GPS: " + err.message;
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
          );
        },
        (err) => {
          info.textContent = "‚ùå Erro ao obter localiza√ß√£o: " + err.message;
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    </script>
  </body>
</html>
