<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Navega√ß√£o AR GPS Est√°vel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      #info {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        background: rgba(0,0,0,0.6);
        padding: 8px 14px;
        border-radius: 10px;
        font-family: sans-serif;
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <div id="info">Obtendo localiza√ß√£o...</div>

    <a-scene
      xr-mode-ui="enabled: false"
      embedded
      renderer="antialias: true; alpha: true;"
      arjs="sourceType: webcam; videoTexture: true; trackingMethod: best; debugUIEnabled: false;"
    >
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const info = document.getElementById("info");
      const cena = document.querySelector("a-scene");
      let modelo = null;
      let destino = null;
      let ultimaPosicao = null;

      // Desloca coordenadas alguns metros √† frente
      function deslocarCoordenadas(lat, lon, distancia, direcaoGraus) {
        const R = 6378137;
        const dLat = (distancia * Math.cos((direcaoGraus * Math.PI) / 180)) / R;
        const dLon = (distancia * Math.sin((direcaoGraus * Math.PI) / 180)) / (R * Math.cos((lat * Math.PI) / 180));
        return {
          lat: lat + dLat * (180 / Math.PI),
          lon: lon + dLon * (180 / Math.PI),
        };
      }

      // Dist√¢ncia entre dois pontos GPS (em metros)
      function distanciaMetros(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Filtro de estabilidade ‚Äî evita varia√ß√£o de ru√≠do do GPS
      function posicaoEstavel(posAtual, ultima) {
        if (!ultima) return true;
        const dist = distanciaMetros(posAtual.lat, posAtual.lon, ultima.lat, ultima.lon);
        return dist > 1; // s√≥ atualiza se mover mais de 1 metro
      }

      // Atualiza continuamente
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const atual = { lat, lon };

          // Ignora pequenas oscila√ß√µes
          if (!posicaoEstavel(atual, ultimaPosicao)) return;
          ultimaPosicao = atual;

          // Define destino inicial a 5 metros √† frente
          if (!destino) {
            destino = deslocarCoordenadas(lat, lon, 5, 0);
            modelo = document.createElement("a-entity");
            modelo.setAttribute("gps-entity-place", {
              latitude: destino.lat,
              longitude: destino.lon,
            });
            modelo.setAttribute("gltf-model", "./modelos/Cubo.glb");
            modelo.setAttribute("scale", "1 1 1");
            modelo.setAttribute("rotation", "0 180 0");
            modelo.setAttribute("animation", "property: rotation; to: 0 540 0; loop: true; dur: 4000");
            cena.appendChild(modelo);
          }

          const dist = distanciaMetros(lat, lon, destino.lat, destino.lon);
          info.textContent = `üìç Dist√¢ncia: ${dist.toFixed(2)} m`;

          // Se chegar perto, move o modelo 5m √† frente novamente
          if (dist < 1) {
            destino = deslocarCoordenadas(lat, lon, 5, 0);
            modelo.setAttribute("gps-entity-place", {
              latitude: destino.lat,
              longitude: destino.lon,
            });
            info.textContent = "üéØ Novo ponto a 5 m definido!";
          }
        },
        (err) => {
          info.textContent = "Erro ao obter GPS: " + err.message;
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );
    </script>
  </body>
</html>
